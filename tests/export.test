(use-modules (ice-9 receive))

(load-from-path "env.scm")

(define file (getenv "FILE"))
(define skip-file-tests (string-null? file))
(define compare (getenv "COMPARE"))
(define skip-compare-tests (string-null? compare))
(define identify (getenv "IDENTIFY"))
(define skip-identify-tests (string-null? identify))

(define cwd (getcwd))
(define *testdir* (build-filename (getcwd) "export-tmp"))

;;; Setup/teardown directories/files needed by tests.
(define (test-setup)
  (mkdir *testdir*)
  (chdir *testdir*))

(define (test-teardown)
  (chdir cwd)
  (system* "rm" "-rf" *testdir*))


(test-begin "lepton-cli export")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export")
  (test-eq EXIT_FAILURE <status>)
  (test-assert (string-contains <stderr> "ERROR: You must specify at least one input filename."))
  (test-assert (string-contains <stderr> "Run `lepton-cli export --help' for more information.")))

(test-end "lepton-cli export")

(define help-string
  "Export Lepton EDA files in various image formats.")

(test-begin "export -h")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "-h")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> help-string)))

(test-end "export -h")


(test-begin "export --help")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "--help")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> help-string)))

(test-end "export --help")


(test-begin "export -P")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "-P")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> "iso_a4"))
  (test-assert (string-contains <stdout> "na_letter")))

(test-end "export -P")


(test-begin "export --paper-names")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "--paper-names")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> "iso_a4"))
  (test-assert (string-contains <stdout> "na_letter")))

(test-end "export --paper-names")


(define schematic
  (build-filename *abs-top-srcdir*
                  "libleptongui"
                  "tests"
                  "embedded_1.sch"))

(define (file-size-about? filename size)
  (define delta .2)
  (false-if-exception
   (< (* size (- 1 delta))
      (stat:size (stat filename))
      (* size (+ 1 delta)))))


(test-begin "export schematic")

(test-group-with-cleanup "export schematic"
  (test-setup)

  (let ((cli-png (basename (string-append schematic ".cli.png")))
        (export-png (basename (string-append schematic ".export.png"))))
    ;; Test 'lepton-cli export'.

    ;; This command hangs up due to weird things when running
    ;; lepton-cli using pipes defined in command-values().
    ;;   (receive (<status> <stdout> <stderr>)
    ;;       (command-values lepton-cli "export" "-o" cli-png schematic)
    ;;     (test-eq EXIT_SUCCESS <status>))

    (test-run-success lepton-cli "export" "-o" cli-png schematic)
    (test-assert (file-exists? cli-png))
    (file-size-about? cli-png 360000)

    (test-run-success lepton-export "export" "-o" export-png schematic)
    (test-assert (file-exists? export-png))
    (file-size-about? export-png 360000))

  ;; Clean up.
  (test-teardown))

(test-end "export schematic")


(define (make-test-filename name)
  (build-filename *abs-top-srcdir*
                  "utils"
                  "cli"
                  "tests"
                  name))



(when (or skip-compare-tests
          skip-identify-tests)
  (test-skip "export -c"))

(test-begin "export -c")

(test-group-with-cleanup "export -c"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.png")
        (colored-output "box-colored.png"))

    (test-run-success lepton-cli "export"
                      "-k" "100px"
                      "-m" "10px"
                      "-o" output
                      input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "130x130")))
    (test-run-success lepton-cli "export"
                      "-c"
                      "-k" "100px"
                      "-m" "10px"
                      "-o" colored-output
                      input)
    (test-assert (file-exists? colored-output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify colored-output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "130x130")))
    ;; Compare files.  It is enough to test that they are
    ;; different for now.
    (test-run-failure compare "-metric" "MAE" output colored-output "diff.png"))

  ;; Clean up.
  (test-teardown))

(test-end "export -c")


(when skip-file-tests
  (test-skip "export -f"))

(test-begin "export -f")
(test-group-with-cleanup "export -f"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.x"))

    (test-run-success lepton-cli "export" "-f" "png" "-o" output input)
    (test-grep-stdout "PNG" file output)

    (test-run-success lepton-cli "export" "-f" "svg" "-o" output input)
    (test-grep-stdout "SVG" file output)

    (test-run-success lepton-cli "export" "-f" "pdf" "-o" output input)
    (test-grep-stdout "PDF" file output)

    (test-run-success lepton-cli "export" "-f" "ps" "-o" output input)
    (test-grep-stdout "PostScript" file output)

    (test-run-success lepton-cli "export" "-f" "eps" "-o" output input)
    (test-grep-stdout "PostScript" file output)
    (test-grep-stdout "EPS" file output)

    (receive (<status> <stdout> <stderr>)
      (command-values lepton-cli "export" "-f" "x" "-o" output input)
    (test-eq EXIT_FAILURE <status>)
    (test-assert
        (string-contains <stderr> "ERROR: Unsupported output format"))))

  ;; Clean up.
  (test-teardown))

(test-end "export -f")

(when skip-file-tests
  (test-skip "export format"))

(test-begin "export format")
(test-group-with-cleanup "export format"
  (test-setup)

  (let ((input (make-test-filename "box.sch")))

    (test-run-success lepton-cli "export" "-o" "output.png" input)
    (test-grep-stdout "PNG" file "output.png")

    (test-run-success lepton-cli "export" "-o" "output.svg" input)
    (test-grep-stdout "SVG" file "output.svg")

    (test-run-success lepton-cli "export" "-o" "output.pdf" input)
    (test-grep-stdout "PDF" file "output.pdf")

    (test-run-success lepton-cli "export" "-o" "output.ps" input)
    (test-grep-stdout "PostScript" file "output.ps")

    (test-run-success lepton-cli "export" "-o" "output.eps" input)
    (test-grep-stdout "PostScript" file "output.eps")
    (test-grep-stdout "EPS" file "output.eps")

    (receive (<status> <stdout> <stderr>)
      (command-values lepton-cli "export" "-o" "output.x" input)
    (test-eq EXIT_FAILURE <status>)
    (test-assert
        (string-contains <stderr> "ERROR: Cannot find supported format for filename"))))

  ;; Clean up.
  (test-teardown))

(test-end "export format")
