(use-modules (ice-9 receive))

(load-from-path "env.scm")

(define file (getenv "FILE"))
(define skip-file-tests (string-null? file))
(define compare (getenv "COMPARE"))
(define skip-compare-tests (string-null? compare))
(define identify (getenv "IDENTIFY"))
(define skip-identify-tests (string-null? identify))

(define cwd (getcwd))
(define *testdir* (build-filename (getcwd) "export-tmp"))

;;; Setup/teardown directories/files needed by tests.
(define (test-setup)
  (mkdir *testdir*)
  (chdir *testdir*))

(define (test-teardown)
  (chdir cwd)
  (system* "rm" "-rf" *testdir*))


(test-begin "lepton-cli export")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export")
  (test-eq EXIT_FAILURE <status>)
  (test-assert (string-contains <stderr> "ERROR: You must specify at least one input filename."))
  (test-assert (string-contains <stderr> "Run `lepton-cli export --help' for more information.")))

(test-end "lepton-cli export")

(define help-string
  "Export Lepton EDA files in various image formats.")

(test-begin "export -h")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "-h")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> help-string)))

(test-end "export -h")


(test-begin "export --help")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "--help")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> help-string)))

(test-end "export --help")


(test-begin "export -P")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "-P")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> "iso_a4"))
  (test-assert (string-contains <stdout> "na_letter")))

(test-end "export -P")


(test-begin "export --paper-names")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "--paper-names")
  (test-eq EXIT_SUCCESS <status>)
  (test-assert (string-contains <stdout> "iso_a4"))
  (test-assert (string-contains <stdout> "na_letter")))

(test-end "export --paper-names")


(define schematic
  (build-filename *abs-top-srcdir*
                  "libleptongui"
                  "tests"
                  "embedded_1.sch"))

(define (file-size-about? filename size)
  (define delta .2)
  (false-if-exception
   (< (* size (- 1 delta))
      (stat:size (stat filename))
      (* size (+ 1 delta)))))


(test-begin "export schematic")

(test-group-with-cleanup "export schematic"
  (test-setup)

  (let ((cli-png (basename (string-append schematic ".cli.png")))
        (export-png (basename (string-append schematic ".export.png"))))
    ;; Test 'lepton-cli export'.

    ;; This command hangs up due to weird things when running
    ;; lepton-cli using pipes defined in command-values().
    ;;   (receive (<status> <stdout> <stderr>)
    ;;       (command-values lepton-cli "export" "-o" cli-png schematic)
    ;;     (test-eq EXIT_SUCCESS <status>))

    (test-run-success lepton-cli "export" "-o" cli-png schematic)
    (test-assert (file-exists? cli-png))
    (file-size-about? cli-png 360000)

    (test-run-success lepton-export "export" "-o" export-png schematic)
    (test-assert (file-exists? export-png))
    (file-size-about? export-png 360000))

  ;; Clean up.
  (test-teardown))

(test-end "export schematic")


(define (make-test-filename name)
  (build-filename *abs-top-srcdir*
                  "utils"
                  "cli"
                  "tests"
                  name))



(when (or skip-compare-tests
          skip-identify-tests)
  (test-skip "export -c"))

(test-begin "export -c")

(test-group-with-cleanup "export -c"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.png")
        (colored-output "box-colored.png"))

    (test-run-success lepton-cli "export"
                      "-k" "100px"
                      "-m" "10px"
                      "-o" output
                      input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "130x130")))
    (test-run-success lepton-cli "export"
                      "-c"
                      "-k" "100px"
                      "-m" "10px"
                      "-o" colored-output
                      input)
    (test-assert (file-exists? colored-output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify colored-output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "130x130")))
    ;; Compare files.  It is enough to test that they are
    ;; different for now.
    (test-run-failure compare "-metric" "MAE" output colored-output "diff.png"))

  ;; Clean up.
  (test-teardown))

(test-end "export -c")


(when skip-file-tests
  (test-skip "export -f"))

(test-begin "export -f")
(test-group-with-cleanup "export -f"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.x"))

    (test-run-success lepton-cli "export" "-f" "png" "-o" output input)
    (test-grep-stdout "PNG" file output)

    (test-run-success lepton-cli "export" "-f" "svg" "-o" output input)
    (test-grep-stdout "SVG" file output)

    (test-run-success lepton-cli "export" "-f" "pdf" "-o" output input)
    (test-grep-stdout "PDF" file output)

    (test-run-success lepton-cli "export" "-f" "ps" "-o" output input)
    (test-grep-stdout "PostScript" file output)

    (test-run-success lepton-cli "export" "-f" "eps" "-o" output input)
    (test-grep-stdout "PostScript" file output)
    (test-grep-stdout "EPS" file output)

    (receive (<status> <stdout> <stderr>)
      (command-values lepton-cli "export" "-f" "x" "-o" output input)
    (test-eq EXIT_FAILURE <status>)
    (test-assert
        (string-contains <stderr> "ERROR: Unsupported output format"))))

  ;; Clean up.
  (test-teardown))

(test-end "export -f")

(when skip-file-tests
  (test-skip "export format"))

(test-begin "export format")
(test-group-with-cleanup "export format"
  (test-setup)

  (let ((input (make-test-filename "box.sch")))

    (test-run-success lepton-cli "export" "-o" "output.png" input)
    (test-grep-stdout "PNG" file "output.png")

    (test-run-success lepton-cli "export" "-o" "output.svg" input)
    (test-grep-stdout "SVG" file "output.svg")

    (test-run-success lepton-cli "export" "-o" "output.pdf" input)
    (test-grep-stdout "PDF" file "output.pdf")

    (test-run-success lepton-cli "export" "-o" "output.ps" input)
    (test-grep-stdout "PostScript" file "output.ps")

    (test-run-success lepton-cli "export" "-o" "output.eps" input)
    (test-grep-stdout "PostScript" file "output.eps")
    (test-grep-stdout "EPS" file "output.eps")

    (receive (<status> <stdout> <stderr>)
      (command-values lepton-cli "export" "-o" "output.x" input)
    (test-eq EXIT_FAILURE <status>)
    (test-assert
        (string-contains <stderr> "ERROR: Cannot find supported format for filename"))))

  ;; Clean up.
  (test-teardown))

(test-end "export format")

(when skip-identify-tests
  (test-skip "export -p"))

(test-begin "export -p")
(test-group-with-cleanup "export -p"
  (test-setup)

  (let ((input-box (make-test-filename "box.sch"))
        (input-horiz (make-test-filename "box-horiz.sch"))
        (input-vert (make-test-filename "box-vert.sch"))
        (output-box "box.png")
        (output-horiz "box-horiz.png")
        (output-vert "box-vert.png"))

    (test-run-success lepton-cli "export" "-o" output-box "-p" "iso_a4" input-box)
    (test-assert (file-exists? output-box))
    (test-run-success lepton-cli "export" "-o" output-horiz "-p" "iso_a4" input-horiz)
    (test-assert (file-exists? output-horiz))
    (test-run-success lepton-cli "export" "-o" output-vert "-p" "iso_a4" input-vert)
    (test-assert (file-exists? output-vert))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-box)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "794x1123")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-horiz)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "1123x794")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-vert)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "794x1123"))))

  ;; Clean up.
  (test-teardown))

(test-end "export -p")


(when skip-identify-tests
  (test-skip "export -s"))

;;; Some tests here output glitches as white 1px lines on two
;;; edges of boxes.  This should be addressed some day.

(test-begin "export -s")
(test-group-with-cleanup "export -s"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.png"))

    ;; Export without margins.
    ;; Default unit is 'pt' so '100:100' means '100pt:100pt'.
    (test-run-success lepton-cli "export" "-m" "0" "-s" "100:100" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "134x134")))

    (test-run-success lepton-cli "export" "-m" "0" "-s" "100pt:100pt" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "134x134")))

    (test-run-success lepton-cli "export" "-m" "0" "-s" "100px:100px" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "100x100")))

    (test-run-success lepton-cli "export" "-m" "0" "-s" "1cm:1cm" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "38x38")))

    (test-run-success lepton-cli "export" "-m" "0" "-s" "10mm:10mm" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "38x38")))

    (test-run-success lepton-cli "export" "-m" "0" "-s" "1in:1in" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "96x96")))

    (test-run-success lepton-cli "export" "-m" "0" "-s" "10pc:10pc" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "160x160")))
    )

  ;; Clean up.
  (test-teardown))

(test-end "export -s")


(when skip-identify-tests
  (test-skip "export -k"))

(test-begin "export -k")
(test-group-with-cleanup "export -k"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.png"))

    ;; Export without margins.
    (test-run-success lepton-cli "export" "-m" "0" "-k" "5mm" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "21x21")))

    (test-run-success lepton-cli "export" "-m" "0" "-k" "1cm" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "42x42")))
    )

  ;; Clean up.
  (test-teardown))

(test-end "export -k")


(when skip-identify-tests
  (test-skip "export -d"))

(test-begin "export -d")
(test-group-with-cleanup "export -d"
  (test-setup)

  (let ((input (make-test-filename "box.sch"))
        (output "box.png"))

    ;; Export a4 without margins.
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-m" "0" "-d" "100" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "827x1170")))

    (test-run-success lepton-cli "export" "-p" "iso_a4" "-m" "0" "-d" "200" "-o" output input)
    (test-assert (file-exists? output))
    (receive (<status> <stdout> <stderr>)
        (command-values identify output)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "1654x2339")))
    )

  ;; Clean up.
  (test-teardown))

(test-end "export -d")


(test-begin "export --")

(receive (<status> <stdout> <stderr>)
    (command-values lepton-cli "export" "--" "-o" "x.png" "x.sch")
  (test-eq EXIT_FAILURE <status>)
  (test-assert
      (string-contains <stderr> "ERROR: You must specify an output filename.")))

(test-end "export --")


(test-begin "export -F")
(test-group-with-cleanup "export -F"
  (test-setup)

  (let ((input (make-test-filename "text.sch"))
        (output-sans "text-sans.ps")
        (output-serif "text-serif.ps"))

    ;; Export to PostScript using different fonts and check that
    ;; output files differ.
    (test-run-success lepton-cli "export" "-F" "Sans" "-o" output-sans input)
    (test-assert (file-exists? output-sans))
    (test-run-success lepton-cli "export" "-F" "Serif" "-o" output-serif input)
    (test-assert (file-exists? output-serif))

    (let ((font-sans #f)
          (font-serif #f))
      (receive (<status> <stdout> <stderr>)
          (command-values "grep" "FontName" output-sans)
        (test-eq EXIT_SUCCESS <status>)
        (set! font-sans <stdout>))

      (receive (<status> <stdout> <stderr>)
          (command-values "grep" "FontName" output-serif)
        (test-eq EXIT_SUCCESS <status>)
        (set! font-serif <stdout>))

      (test-assert (not (string= font-sans font-serif)))))

  ;; Clean up.
  (test-teardown))

(test-end "export -F")


(when skip-identify-tests
  (test-skip "export -l"))

(test-begin "export -l")

(test-group-with-cleanup "export -l"
  (test-setup)

  (let ((input-horiz (make-test-filename "box-horiz.sch"))
        (input-vert (make-test-filename "box-vert.sch"))
        (output-plain "plain.png")
        (output-auto "auto.png")
        (output-portrait "portrait.png")
        (output-landscape "landscape.png"))

    (test-run-success lepton-cli "export" "-p" "iso_a4" "-o" output-plain input-horiz)
    (test-assert (file-exists? output-plain))
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-l" "auto" "-o" output-auto input-horiz)
    (test-assert (file-exists? output-auto))
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-l" "portrait" "-o" output-portrait input-horiz)
    (test-assert (file-exists? output-portrait))
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-l" "landscape" "-o" output-landscape input-horiz)
    (test-assert (file-exists? output-landscape))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-plain)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "1123x794")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-auto)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "1123x794")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-portrait)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "794x1123")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-landscape)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "1123x794")))

    (test-run-success lepton-cli "export" "-p" "iso_a4" "-o" output-plain input-vert)
    (test-assert (file-exists? output-plain))
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-l" "auto" "-o" output-auto input-vert)
    (test-assert (file-exists? output-auto))
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-l" "portrait" "-o" output-portrait input-vert)
    (test-assert (file-exists? output-portrait))
    (test-run-success lepton-cli "export" "-p" "iso_a4" "-l" "landscape" "-o" output-landscape input-vert)
    (test-assert (file-exists? output-landscape))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-plain)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "794x1123")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-auto)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "794x1123")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-portrait)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "794x1123")))

    (receive (<status> <stdout> <stderr>)
        (command-values identify output-landscape)
      (test-eq EXIT_SUCCESS <status>)
      (test-assert
          (string-contains <stdout> "1123x794")))
    )

  ;; Clean up.
  (test-teardown))

(test-end "export -l")
