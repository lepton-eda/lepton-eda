;;; Test Scheme procedures related to pcb elements.

(use-modules (system foreign)
             (sch2pcb element))


(test-begin "pkg-line->element")

;;; Test that *PcbElement is created successfully from a proper
;;; string.  Test its fields as well.
(let ((*element (pkg-line->element "PKG_DIP14(DIP14,U100,unknown)")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "DIP14")
  (test-equal (pcb-element-refdes *element) "U100")
  (test-equal (pcb-element-value *element) "unknown")
  (free-element *element))

;;; Element's fields with whitespaces.
(let ((*element (pkg-line->element "PKG_DIP14(DIP14\t, U100,unknown  )")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "DIP14_")
  (test-equal (pcb-element-refdes *element) "_U100")
  (test-equal (pcb-element-value *element) "unknown__")
  (free-element *element))

;;; Element's fields with several closing parens after the value.
(let ((*element (pkg-line->element "PKG_DIP14(DIP14,U100,unknown))))")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "DIP14")
  (test-equal (pcb-element-refdes *element) "U100")
  (test-equal (pcb-element-value *element) "unknown")
  (free-element *element))

;;; Element's fields with several closing parens and text after
;;; the value.
(let ((*element (pkg-line->element "PKG_DIP14(DIP14,U100,unknown)))text")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "DIP14")
  (test-equal (pcb-element-refdes *element) "U100")
  (test-equal (pcb-element-value *element) "unknown")
  (free-element *element))

;;; Element with extra description arguments.
(let ((*element (pkg-line->element "PKG_100-Pin-jack(100-Pin-jack,refdes,value,Pin,jack)")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "100-Pin-jack")
  (test-equal (pcb-element-refdes *element) "refdes")
  (test-equal (pcb-element-value *element) "value")
  (test-equal (pcb-element-pkg-name-fix *element) "Pin jack")
  (free-element *element))

;;; Element with value containing a comma.
(let ((*element (pkg-line->element "PKG_XXX(R0w8,R100,1k, 1%)")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "R0w8")
  (test-equal (pcb-element-refdes *element) "R100")
  (test-equal (pcb-element-value *element) "1k,_1%")
  (free-element *element))

;;; Element with value containing a comma, a closing paren, and
;;; some text after it.
(let ((*element (pkg-line->element "PKG_XXX(R0w8,R100,1k, 1%)text")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "R0w8")
  (test-equal (pcb-element-refdes *element) "R100")
  (test-equal (pcb-element-value *element) "1k,_1%")
  (free-element *element))

;;; Element with value containing a comma and several closing
;;; parens.
(let ((*element (pkg-line->element "PKG_XXX(R0w8,R100,1k, 1%)))))")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "R0w8")
  (test-equal (pcb-element-refdes *element) "R100")
  (test-equal (pcb-element-value *element) "1k,_1%")
  (free-element *element))

;;; Element with multi-word description and value containing a
;;; comma.
(let ((*element (pkg-line->element "PKG_YYY-multi-word(R0w8-multi-word,R100,1k, 1%,multi,word)")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "R0w8-multi-word")
  (test-equal (pcb-element-refdes *element) "R100")
  (test-equal (pcb-element-value *element) "1k,_1%")
  (test-equal (pcb-element-pkg-name-fix *element) "multi word")
  (free-element *element))

;;; Probably it behaves wrong when two or three closing parens are
;;; present?
(let ((*element (pkg-line->element "PKG_YYY-multi-word-again(R0w8-multi-word-again,R100,1k, 1%,multi,word,again)))")))
  (test-assert (not (null-pointer? *element)))
  (test-equal (pcb-element-description *element) "R0w8-multi-word-again")
  (test-equal (pcb-element-refdes *element) "R100")
  (test-equal (pcb-element-value *element) "1k,_1%")
  (test-equal (pcb-element-pkg-name-fix *element) "multi word again")
  (free-element *element))

;;; Wrong PKG_ strings.

;;; No left paren at all.
(test-assert (null-pointer? (pkg-line->element "PKG_DIP14")))
;;; Missing "PKG_" prefix.
(test-assert (null-pointer? (pkg-line->element "DIP14(DIP14,U100,unknown)")))
;;; Wrong amount of arguments in parens (less than 3).
(test-assert (null-pointer? (pkg-line->element "PKG_DIP14(DIP14,U100)")))

(test-end)
